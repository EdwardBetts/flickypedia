{% extends "base.html" %}

{% block head %}
  <script src="{{ url_for('static', filename='flickypedia.js') }}"></script>

  <style>
  #chosenCategories li {
    margin-bottom: 0 !important;
  }

  #chosenCategories a {
    margin-left: 10px;
  }
  </style>

  <script>
    window.onload = function() {
      document
        .querySelectorAll('input[data-type="title"]')
        .forEach(input => addTitleValidatorTo(input));

      document
        .querySelectorAll('textarea[data-type="short_caption"]')
        .forEach(textarea => {
          const counterElement =
            document.querySelector(`label[for=${textarea.id}] .charCounter`);

          addCharCounterTo(textarea, counterElement);
        });

      const textArea = document.querySelector("#photo_31545143905-categories");

      textArea.style.background = "yellow";
      textArea.style.opacity = 0.5;

      var inputElement = document.createElement("input");
      inputElement.type = "text";

      const listElement = document.querySelector("#chosenCategories");

      inputElement.addEventListener("input", () => {
        if (inputElement.value === "") {
          return;
        }
      })

      inputElement.addEventListener("keypress", event => {
        console.log(event.key);

        if (event.key === 'Enter') {
          const thisValue = inputElement.value;

          existingCategories = textArea.value === '' ? [] : JSON.parse(textArea.value);
          existingCategories.push(inputElement.value);

          textArea.value = JSON.stringify(existingCategories);

          const listEntry = document.createElement("li");

          const span = document.createElement("span");
          span.innerHTML = inputElement.value;
          listEntry.appendChild(span);

          const close = document.createElement("a");
          close.innerHTML = "[X]"
          close.onclick = function() {
            existingCategories = textArea.value === '' ? [] : JSON.parse(textArea.value);
            existingCategories = existingCategories.filter(v => v != thisValue);
            textArea.value = JSON.stringify(existingCategories);

            listElement.removeChild(listEntry);
          }

          listEntry.appendChild(close);

          listElement.appendChild(listEntry);

          inputElement.value = "";


          event.preventDefault();
        }
      });

      document.querySelector("#categoriesController").appendChild(inputElement);
    }
  </script>
{% endblock %}

{% block content %}
  {% include "components/header.html" %}

  <h2>Prepare info</h2>

  <style>
    #prepare_info li {
      margin-bottom: 2em;
    }

    .info {
      display: grid;
      grid-gap: 15px;
      grid-template-columns: 200px auto;
      grid-template-rows: 20px auto auto;
    }

    .from_flickr {
      grid-column: 1 / 2;
      grid-row: 1 / 3;
    }

    .to_wiki {
      grid-column: 2 / 2;
      grid-row: 1 / 3;
    }

    .flickr_info {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
    }

    .wiki_info {
      grid-column: 2 / 2;
      grid-row: 2 / 3;
    }

    .wiki_info label:not(:first-child) {
      display: block;
      margin-top: 1.5em;
    }

    .sdc {
      grid-column: 1 / span 2;
      grid-row: 3 / 3;
      background: rgb(var(--brown));
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
    }

    .to_from_with_logo {
      display: grid;

      height: 25px;
    }

    .to_from_with_logo.from_flickr {
      grid-template-columns: 30px auto;
    }

    .to_from_with_logo.to_wiki {
      grid-template-columns: 24px auto;
    }

    .to_from_with_logo img {
      height: 25px;
    }

    .to_from_with_logo div {
      font-size: small;
      line-height: 25px;
      color: rgb(var(--grey));
    }

    .preview {
      position: relative;
    }

    .preview .image_counter {
      position: absolute;
      right: 0;
      top: -12px;
      background: rgb(var(--black));
      color: rgb(var(--cream));
      padding: 1px 20px;
      font-size: 2em;
      font-weight: bold;
    }
  </style>

  <form id="prepare_info" action="" method="post">
    {{ prepare_info_form.hidden_tag() }}

    <!-- TODO: These messages need to be plural-aware -->

    <h3>
      <span class="highlight">First</span>, please set the language youâ€™ll be using to write your captions:
    </h3>

    {{ prepare_info_form.language() }}

    <h3>
      <span class="highlight">Next</span>, please add Titles and Captions for each photo, and optional Wikimedia Commons categories:
    </h3>

    <ul class="plain_list">
      {% for field in photo_fields %}
        {% set photo = field.label.text %}
        <li>

        {% set large_size = photo.sizes | size_at(desired_size='Large') %}

        {% if loop.length > 1 %}
          <div class="preview">
            <div class="image_counter">
              {{ loop.index }} of {{ loop.length }}
            </div>

            <img
              src="{{ large_size.source }}"
              style="aspect-ratio: {{ large_size.width }} / {{ large_size.height }}"
            >
          </div>
        {% else %}
          <img
            src="{{ large_size.source }}"
            style="aspect-ratio: {{ large_size.width }} / {{ large_size.height }}"
          >
        {% endif %}

        <div class="info">
          <div class="to_from_with_logo from_flickr">
            <img src="{{ url_for('static', filename='flickr-logo.svg') }}">

            <div>From Flickr</div>
          </div>

          <div class="to_from_with_logo to_wiki">
            <img src="{{ url_for('static', filename='wikimedia-commons-logo.svg') }}">

            <div>To the Wikimedia Commons Entry</div>
          </div>

          {% include "components/prepare_info_flickr_photo_info.html" %}

          <div class="wiki_info">
            <label for="{{ field.title.id }}">
              Title
              <div class="required">required</div>
            </label>
            {{
              field.title(
                data_type="title",
                data_originalformat=photo['original_format']
              )
            }}

            <p class="validation_errors
                      {% if not field.title.errors %}hidden{% endif %}"
               for="{{ field.title.id }}">
              {{ " ".join(field.title.errors) }}
            </p>

            <label for="{{ field.short_caption.id }}">
              Short caption
              <div class="required">required</div>
              <div class="charCounter"></div>
            </label>
            {{ field.short_caption(data_type="short_caption", rows="3") }}

            <!--
              This error message comes from the server, but users with
              JS enabled will get an inline message that updates with
              the number of characters in real-time.

              We only need to show the error from the server if the
              user doesn't have JS enabled.
             -->
            {% if field.short_caption.errors %}
              <noscript>
                <p class="validation_errors">
                  {{ " ".join(field.short_caption.errors) }}
                </p>
              </noscript>
            {% endif %}

            <p>
              <label for="{{ field.categories.id }}">Add a Wikimedia Commons category</label>

              {{ field.categories() }}
            </p>

            <div id="categoriesController">
            </div>

            <ul id="chosenCategories">
            </ul>
          </div>

          <details class="sdc">
            <summary>More details</summary>

            {% with structured_data = photo.sdc %}
              {% include "components/structured_data_preview.html" %}
            {% endwith %}
          </details>
        </div>
        </li>
      {% endfor %}
    </ul>

    <p>{{ prepare_info_form.upload(class="pink_button") }}</p>
  </form>
{% endblock %}
